local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local function createCheek(name, size, offset, torsoAttachment, model, hrp, color)
	local ball = Instance.new("Part")
	ball.Name = name
	ball.Size = size
	ball.Shape = Enum.PartType.Ball
	ball.BrickColor = color
	ball.CanCollide = false
	ball.Massless = true
	ball.Position = hrp.Position + offset
	ball.Parent = model

	local attachment = Instance.new("Attachment")
	attachment.Parent = ball

	local spring = Instance.new("SpringConstraint")
	spring.Attachment0 = torsoAttachment
	spring.Attachment1 = attachment
	spring.LimitsEnabled = true
	spring.MaxLength = 0.05
	spring.Stiffness = 10
	spring.Damping = 5
	spring.Parent = model

	return ball, attachment
end

local function setupCharacter(character)
	local humanoid = character:WaitForChild("Humanoid")
	local hrp = character:FindFirstChild("HumanoidRootPart")
	if not hrp then return end

	local torsoAttachment1
	local torsoAttachment2
	local torsoPart

	if humanoid.RigType == Enum.HumanoidRigType.R15 then
		local original = character:FindFirstChild("LowerTorso")
		if not original then return end
		torsoPart = original:Clone()
		torsoPart.CanCollide = false
		torsoPart.Parent = workspace
		torsoPart.Transparency = 1
		torsoPart:ClearAllChildren()
		torsoPart.Anchored = true

		RunService.RenderStepped:Connect(function()
			if original and torsoPart then
				torsoPart.CFrame = original.CFrame
			end
		end)

		torsoAttachment1 = Instance.new("Attachment")
		torsoAttachment1.Position = Vector3.new(0.3, 0, 0.5)
		torsoAttachment1.Parent = torsoPart

		torsoAttachment2 = Instance.new("Attachment")
		torsoAttachment2.Position = Vector3.new(-0.3, 0, 0.5)
		torsoAttachment2.Parent = torsoPart
	else
		local original = character:FindFirstChild("Torso")
		if not original then return end
		torsoPart = original:Clone()
		torsoPart.Parent = workspace
		torsoPart.CanCollide = false
		torsoPart.Transparency = 1
		torsoPart:ClearAllChildren()
		torsoPart.Anchored = true

		RunService.RenderStepped:Connect(function()
			if original and torsoPart then
				torsoPart.CFrame = original.CFrame
			end
		end)

		torsoAttachment1 = Instance.new("Attachment")
		torsoAttachment1.Position = Vector3.new(0.3, -0.5, 0.5)
		torsoAttachment1.Parent = torsoPart

		torsoAttachment2 = Instance.new("Attachment")
		torsoAttachment2.Position = Vector3.new(-0.3, -0.5, 0.5)
		torsoAttachment2.Parent = torsoPart
	end

	for _, child in ipairs(character:GetChildren()) do
		if child:IsA("Pants") then
			child:Destroy()
		end
	end

	local torsoColor = BrickColor.new("Medium stone grey")
	local bodyColors = character:FindFirstChild("Body Colors")
	if bodyColors then
		torsoColor = bodyColors.TorsoColor
	end

	local cheekModel = Instance.new("Model")
	cheekModel.Name = "Cheeks_Local_" .. character.Name
	cheekModel.Parent = workspace

	local ball1, att1 = createCheek("Cheek1", Vector3.new(1.2,1.2,1.2), Vector3.new(0.3, -0.5, 0.5), torsoAttachment1, cheekModel, hrp, torsoColor)
	local ball2, att2 = createCheek("Cheek2", Vector3.new(1.2,1.2,1.2), Vector3.new(-0.3, -0.5, 0.5), torsoAttachment2, cheekModel, hrp, torsoColor)

	local springLink = Instance.new("SpringConstraint")
	springLink.Attachment0 = att1
	springLink.Attachment1 = att2
	springLink.LimitsEnabled = true
	springLink.MaxLength = 0.5
	springLink.Stiffness = 10
	springLink.Damping = 5
	springLink.Parent = cheekModel
end

for _, player in Players:GetPlayers() do
	if player.Character then
		setupCharacter(player.Character)
	end
	player.CharacterAdded:Connect(setupCharacter)
end

Players.PlayerAdded:Connect(function(player)
	player.CharacterAdded:Connect(function(char)
		setupCharacter(char)
	end)
end)

Players.PlayerRemoving:Connect(function(plr)
	local Cheeck = workspace:FindFirstChild("Cheeks_Local_".. plr.Name)
end)
